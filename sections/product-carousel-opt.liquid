{% comment %}
  Product Carousel Opt - Clean, simple, bug-free implementation
  Built from scratch for optimal performance
{% endcomment %}

<div class="py-12 lg:py-10" id="carousel-opt-{{ section.id }}">
  <div class="max-w-screen-2xl mx-auto">

    {%- comment -%} Header Section {%- endcomment -%}
    {% if section.settings.title != blank or section.settings.show_view_all %}
      <div class="flex justify-between items-end mb-6 lg:mb-8 px-4 lg:px-12">
        <div class="flex flex-col gap-2">
          {% if section.settings.title != blank %}
            <h2 class="text-2xl lg:text-3xl font-bold">{{ section.settings.title }}</h2>
          {% endif %}
          {% if section.settings.rich_text != blank %}
            <div class="text-sm lg:text-base text-gray-600">
              {{ section.settings.rich_text }}
            </div>
          {% endif %}
        </div>

        {%- comment -%} View All Link (desktop only) {%- endcomment -%}
        {% if section.settings.show_view_all %}
          {% assign view_all_url = '' %}
          {% case section.settings.product_source %}
            {% when 'collections' %}
              {% assign view_all_url = section.settings.view_all_link_collections %}
            {% else %}
              {% assign view_all_url = section.settings.view_all_link %}
          {% endcase %}

          {% if view_all_url != blank %}
            <a
              href="{{ view_all_url }}"
              class="hidden lg:block text-sm underline hover:no-underline transition-all"
            >
              {{ section.settings.view_all_text | default: 'Ver todos' }}
            </a>
          {% endif %}
        {% endif %}
      </div>
    {% endif %}

    {%- comment -%} Build Products Array {%- endcomment -%}
    {% assign products = blank %}
    {% case section.settings.product_source %}
      {% when 'collection' %}
        {% if section.settings.collection != blank %}
          {% assign products = section.settings.collection.products %}
        {% endif %}

      {% when 'collections' %}
        {% if section.settings.collections.size > 0 %}
          {% assign all_products = blank %}
          {% for collection in section.settings.collections limit: 10 %}
            {% for product in collection.products limit: 3 %}
              {% if product.available %}
                {% unless all_products contains product.id %}
                  {% if all_products == blank %}
                    {% assign all_products = product.id | append: ',' %}
                  {% else %}
                    {% assign all_products = all_products | append: product.id | append: ',' %}
                  {% endif %}
                {% endunless %}
              {% endif %}
            {% endfor %}
          {% endfor %}

          {%- comment -%} Now get actual products from IDs {%- endcomment -%}
          {% assign product_ids = all_products | split: ',' %}
          {% assign products = blank %}
          {% for collection in section.settings.collections %}
            {% for product in collection.products %}
              {% if product_ids contains product.id %}
                {% if products == blank %}
                  {% assign products = product | split: '|' %}
                {% else %}
                  {% assign temp_product = product | split: '|' %}
                  {% assign products = products | concat: temp_product %}
                {% endif %}
              {% endif %}
            {% endfor %}
          {% endfor %}
        {% endif %}

      {% when 'tags' %}
        {% if section.settings.product_tags != blank %}
          {% assign tags = section.settings.product_tags | split: ',' %}
          {% assign products = blank %}
          {% for product in collections.all.products %}
            {% if product.available %}
              {% for tag in tags %}
                {% assign clean_tag = tag | strip %}
                {% if product.tags contains clean_tag %}
                  {% if products == blank %}
                    {% assign products = product | split: '|' %}
                  {% else %}
                    {% assign temp_product = product | split: '|' %}
                    {% assign products = products | concat: temp_product %}
                  {% endif %}
                  {% break %}
                {% endif %}
              {% endfor %}
            {% endif %}
          {% endfor %}
        {% endif %}

      {% when 'manual' %}
        {% assign products = section.settings.products %}
    {% endcase %}

    {%- comment -%} Filter and count available products {%- endcomment -%}
    {% assign available_products = blank %}
    {% assign count = 0 %}
    {% for product in products %}
      {% if product.available and count < section.settings.max_products %}
        {% if available_products == blank %}
          {% assign available_products = product | split: '|' %}
        {% else %}
          {% assign temp = product | split: '|' %}
          {% assign available_products = available_products | concat: temp %}
        {% endif %}
        {% assign count = count | plus: 1 %}
      {% endif %}
    {% endfor %}

    {%- comment -%} Render Products or Empty Message {%- endcomment -%}
    {% if count > 0 %}

      {%- comment -%} Navigation Arrows (desktop only) {%- endcomment -%}
      {% if section.settings.show_arrows %}
        <div class="hidden lg:flex justify-end gap-2 px-12 mb-4">
          <button
            class="carousel-prev-{{ section.id }} w-8 h-8 rounded-full bg-gray-300 text-gray-500 flex items-center justify-center transition-all disabled:opacity-50 disabled:cursor-not-allowed"
            aria-label="Previous"
            disabled
          >
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/>
            </svg>
          </button>
          <button
            class="carousel-next-{{ section.id }} w-8 h-8 rounded-full bg-primary text-white flex items-center justify-center transition-all hover:bg-primary/80 disabled:opacity-50 disabled:cursor-not-allowed"
            aria-label="Next"
          >
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/>
            </svg>
          </button>
        </div>
      {% endif %}

      {%- comment -%} Product Grid/Carousel {%- endcomment -%}
      <div
        class="swiper swiper-{{ section.id }}"
        data-carousel-id="{{ section.id }}"
      >
        <div class="swiper-wrapper">
          {% for product in available_products limit: section.settings.max_products %}
            <div class="swiper-slide">
              {% render 'product-card',
                product: product,
                show_badges: section.settings.show_badges,
                show_rating: section.settings.show_rating,
                show_color_swatches: false,
                show_size_selector: section.settings.show_size_selector,
                mobile_layout: false
              %}
            </div>
          {% endfor %}
        </div>
      </div>

      {%- comment -%} Swipe Hint (mobile only) {%- endcomment -%}
      {% if section.settings.show_swipe_hint %}
        <div class="lg:hidden text-center mt-4 text-sm text-gray-500 px-4">
          ← Desliza para ver más →
        </div>
      {% endif %}

    {% else %}
      <div class="text-center py-12 px-4">
        <p class="text-gray-600">
          {{ section.settings.no_products_message | default: 'No hay productos disponibles.' }}
        </p>
      </div>
    {% endif %}

  </div>
</div>

<style>
  .swiper-{{ section.id }} {
    padding-left: 16px;
    padding-right: 16px;
    overflow: visible;
  }

  @media (min-width: 1024px) {
    .swiper-{{ section.id }} {
      padding-left: 48px;
      padding-right: 48px;
    }
  }

  .swiper-{{ section.id }} .swiper-slide {
    width: auto;
    max-width: 320px;
  }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const sectionId = '{{ section.id }}';
  const swiperEl = document.querySelector('.swiper-' + sectionId);

  if (!swiperEl || typeof Swiper === 'undefined') return;

  const totalProducts = {{ count }};
  const prevBtn = document.querySelector('.carousel-prev-' + sectionId);
  const nextBtn = document.querySelector('.carousel-next-' + sectionId);

  // Initialize Swiper
  const swiper = new Swiper(swiperEl, {
    slidesPerView: 'auto',
    spaceBetween: 16,
    freeMode: {
      enabled: true,
      sticky: false,
    },
    navigation: {
      nextEl: nextBtn,
      prevEl: prevBtn,
    },
    breakpoints: {
      1024: {
        spaceBetween: 24,
      }
    },
    on: {
      init: function() {
        updateArrows(this);
      },
      slideChange: function() {
        updateArrows(this);
      },
      reachBeginning: function() {
        updateArrows(this);
      },
      reachEnd: function() {
        updateArrows(this);
      }
    }
  });

  function updateArrows(swiperInstance) {
    if (!prevBtn || !nextBtn) return;

    // Update prev button
    if (swiperInstance.isBeginning) {
      prevBtn.disabled = true;
      prevBtn.classList.remove('bg-primary', 'text-white', 'hover:bg-primary/80');
      prevBtn.classList.add('bg-gray-300', 'text-gray-500');
    } else {
      prevBtn.disabled = false;
      prevBtn.classList.remove('bg-gray-300', 'text-gray-500');
      prevBtn.classList.add('bg-primary', 'text-white', 'hover:bg-primary/80');
    }

    // Update next button
    if (swiperInstance.isEnd) {
      nextBtn.disabled = true;
      nextBtn.classList.remove('bg-primary', 'text-white', 'hover:bg-primary/80');
      nextBtn.classList.add('bg-gray-300', 'text-gray-500');
    } else {
      nextBtn.disabled = false;
      nextBtn.classList.remove('bg-gray-300', 'text-gray-500');
      nextBtn.classList.add('bg-primary', 'text-white', 'hover:bg-primary/80');
    }
  }
});
</script>

{% schema %}
{
  "name": "Product Carousel Opt",
  "tag": "section",
  "class": "section",
  "settings": [
    {
      "type": "text",
      "id": "title",
      "label": "Carousel Title",
      "default": "Los más vendidos"
    },
    {
      "type": "richtext",
      "id": "rich_text",
      "label": "Rich Text",
      "info": "Optional description below title"
    },
    {
      "type": "header",
      "content": "View All Link"
    },
    {
      "type": "checkbox",
      "id": "show_view_all",
      "label": "Show View All Link",
      "default": true
    },
    {
      "type": "text",
      "id": "view_all_text",
      "label": "View All Text",
      "default": "Ver todos"
    },
    {
      "type": "url",
      "id": "view_all_link",
      "label": "View All Link",
      "info": "For single collection, tags, or manual"
    },
    {
      "type": "url",
      "id": "view_all_link_collections",
      "label": "View All Link (Multiple Collections)"
    },
    {
      "type": "checkbox",
      "id": "show_arrows",
      "label": "Show Navigation Arrows",
      "default": true,
      "info": "Desktop only"
    },
    {
      "type": "checkbox",
      "id": "show_swipe_hint",
      "label": "Show Swipe Hint",
      "default": true,
      "info": "Mobile only"
    },
    {
      "type": "header",
      "content": "Product Selection"
    },
    {
      "type": "select",
      "id": "product_source",
      "label": "Product Source",
      "options": [
        {
          "value": "collection",
          "label": "Single Collection"
        },
        {
          "value": "collections",
          "label": "Multiple Collections"
        },
        {
          "value": "tags",
          "label": "Product Tags"
        },
        {
          "value": "manual",
          "label": "Manual Selection"
        }
      ],
      "default": "collection"
    },
    {
      "type": "collection",
      "id": "collection",
      "label": "Collection"
    },
    {
      "type": "collection_list",
      "id": "collections",
      "label": "Collections",
      "limit": 10
    },
    {
      "type": "text",
      "id": "product_tags",
      "label": "Product Tags",
      "info": "Comma-separated (e.g., bestseller,new)"
    },
    {
      "type": "product_list",
      "id": "products",
      "label": "Manual Products",
      "limit": 20
    },
    {
      "type": "range",
      "id": "max_products",
      "label": "Maximum Products",
      "min": 4,
      "max": 20,
      "step": 1,
      "default": 12
    },
    {
      "type": "header",
      "content": "Product Card Display"
    },
    {
      "type": "checkbox",
      "id": "show_badges",
      "label": "Show Product Badges",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_rating",
      "label": "Show Product Rating",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_size_selector",
      "label": "Show Size Selector",
      "default": true
    },
    {
      "type": "header",
      "content": "Messages"
    },
    {
      "type": "text",
      "id": "no_products_message",
      "label": "No Products Message",
      "default": "No hay productos disponibles."
    }
  ],
  "presets": [
    {
      "name": "Product Carousel Opt"
    }
  ]
}
{% endschema %}
