{% comment %}
  Product Carousel Opt Section
  - Horizontal scrollable carousel using native scroll-snap
  - Single image per product (featured image)
  - Quick add modal with size selection
{% endcomment %}

{% liquid
  assign products = nil

  case section.settings.product_source
    when 'collection'
      if section.settings.collection != blank
        assign products = section.settings.collection.products
      endif
    when 'collections'
      if section.settings.collections.count > 0
        assign products = empty
        assign first_collection = true
        for collection in section.settings.collections
          assign products_added = 0
          assign temp_products = empty
          for product in collection.products
            if product.available and products_added < 3
              if products_added == 0
                assign temp_products = collection.products | where: 'id', product.id
              else
                assign temp_single = collection.products | where: 'id', product.id
                assign temp_products = temp_products | concat: temp_single
              endif
              assign products_added = products_added | plus: 1
            endif
          endfor
          if temp_products != blank
            if first_collection
              assign products = temp_products
              assign first_collection = false
            else
              assign products = products | concat: temp_products
            endif
          endif
        endfor
      endif
    when 'tags'
      if section.settings.product_tags != blank
        assign tag_list = section.settings.product_tags | split: ','
        assign products = collections.all.products
        for tag in tag_list
          assign trimmed_tag = tag | strip
          assign products = products | where: 'tags', trimmed_tag
        endfor
      endif
    when 'manual'
      assign products = section.settings.products
  endcase

%}

{% capture carousel_products %}
  {% assign products_shown = 0 %}
  {% if products %}
    {% for product in products %}
      {% if products_shown < section.settings.max_products %}

        {% assign featured_image = product.featured_image %}
        {% assign size_option_index = nil %}
        {% assign size_title = '' %}
        {% for option in product.options_with_values %}
          {% assign name_down = option.name | downcase %}
          {% if name_down contains 'talla' or name_down contains 'size' %}
            {% assign size_option_index = forloop.index0 %}
            {% assign size_title = option.name %}
            {% break %}
          {% endif %}
        {% endfor %}
        <div class="snap-start shrink-0 w-[85vw] sm:w-[60vw] lg:w-[24%] pr-4 lg:pr-6">
          <article class="w-full h-full flex flex-col">
            <div class="relative w-full aspect-[3/4.5] overflow-hidden bg-gray-50">
              {% if featured_image %}
                <img
                  src="{{ featured_image | image_url: width: 1800 }}"
                  alt="{{ product.title }}"
                  class="absolute inset-0 w-full h-full object-contain object-center"
                  loading="lazy"
                  width="1800"
                  height="1800"
                >
              {% endif %}

              {% if section.settings.show_badges and product.tags.size > 0 %}
                <div class="absolute top-3 left-3 flex flex-wrap gap-2">
                  {% for tag in product.tags limit: 2 %}
                    <span class="bg-white/90 text-gray-900 text-xs font-medium py-1 px-3 rounded-full">
                      {{ tag }}
                    </span>
                  {% endfor %}
                </div>
              {% endif %}

              <button
                class="absolute top-3 right-3 w-10 h-10 rounded-full bg-white/90 flex items-center justify-center text-gray-600 hover:text-red-500"
                aria-label="Agregar a favoritos"
                type="button"
              >
                <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
                  <path d="M12 20l-1.4-1.27C5.8 14.36 2 11.28 2 7.5 2 4.42 4.42 2 7.5 2c1.74 0 3.41.81 4.5 2.09A6.003 6.003 0 0 1 20.5 2C23.58 2 26 4.42 26 7.5c0 3.78-3.8 6.86-8.6 11.23L12 20z" transform="translate(-2)" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </button>

              <div class="absolute left-2 bottom-2 bg-white/90 rounded-full px-3 py-1 text-xs font-semibold text-gray-900">
                {{ product.price | money }}
              </div>

              {% if section.settings.show_size_selector %}
                <button
                  class="absolute right-2 bottom-2 w-8 h-8 rounded-full bg-black text-white flex items-center justify-center"
                  data-open-modal="quick-add-{{ section.id }}-{{ product.id }}"
                  aria-label="Seleccionar talla"
                  type="button"
                >
                  <span class="text-lg leading-none">+</span>
                </button>
              {% endif %}
            </div>

            <div class="flex flex-col gap-1 py-4 px-2 flex-1">
              <a href="{{ product.url }}" class="text-sm lg:text-base font-medium line-clamp-2 hover:text-gray-900">
                {{ product.title }}
              </a>
              <div class="flex gap-2 items-baseline text-sm lg:text-base">
                <span class="font-semibold">{{ product.price | money }}</span>
                {% if product.compare_at_price > product.price %}
                  <span class="text-gray-400 line-through text-xs lg:text-sm">{{ product.compare_at_price | money }}</span>
                {% endif %}
              </div>
              {% if section.settings.show_rating %}
                {% assign rating = product.metafields.reviews.rating.value | default: product.rating %}
                {% if rating %}
                  <div class="flex items-center gap-1 text-xs text-gray-500">
                    <span class="text-yellow-500">&#9733;</span>
                    <span>{{ rating | round: 1 }}/5</span>
                  </div>
                {% endif %}
              {% endif %}
            </div>
          </article>
        </div>

          <div
            id="quick-add-{{ section.id }}-{{ product.id }}"
            class="fixed inset-0 bg-black/50 hidden z-50"
            data-quick-add-modal
          >
            <div
              class="fixed bottom-0 left-0 right-0 bg-white rounded-t-3xl shadow-2xl transform translate-y-full transition-transform duration-300 ease-out max-h-[80vh] overflow-y-auto"
              data-drawer-content
            >
              <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center rounded-t-3xl">
                <h3 class="text-lg font-semibold">Selecciona tu talla</h3>
                <button
                  class="text-gray-500 hover:text-black w-8 h-8 flex items-center justify-center"
                  data-close-modal
                  type="button"
                  aria-label="Cerrar"
                >
                  <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                  </svg>
                </button>
              </div>
              <div class="p-6">
              {% if size_option_index != nil %}
                <p class="text-sm text-gray-500 mb-3">{{ size_title | default: 'Tallas' }}</p>
                <div class="flex flex-col gap-2">
                  {% assign used_sizes = '' %}
                  {% for variant in product.variants %}
                    {% assign size_value = variant.options[size_option_index] %}
                    {% if variant.available %}
                      {% unless used_sizes contains size_value %}
                        <button
                          class="border border-gray-200 rounded-lg py-2 px-3 text-left hover:border-gray-900 flex justify-between items-center"
                          data-add-variant="{{ variant.id }}"
                          type="button"
                        >
                          <span>{{ size_value }}</span>
                          <span class="text-sm text-gray-400">{{ 'products.product.available' | t }}</span>
                        </button>
                        {% assign used_sizes = used_sizes | append: size_value | append: ',' %}
                      {% endunless %}
                    {% endif %}
                  {% endfor %}
                </div>
              {% else %}
                <button
                  class="border border-gray-900 text-white bg-gray-900 rounded-lg py-3 px-4 w-full"
                  data-add-variant="{{ product.selected_or_first_available_variant.id }}"
                  type="button"
                >
                  Anadir {{ product.title }}
                </button>
              {% endif %}
              </div>
            </div>
          </div>
        {% assign products_shown = products_shown | plus: 1 %}
      {% endif %}
    {% endfor %}
  {% endif %}
{% endcapture %}

{% assign total_products = products.size | default: 0 %}

<section
  id="product-carousel-opt-{{ section.id }}"
  class="section py-12 lg:py-10"
  data-product-carousel-opt
>
  <div class="mx-4 lg:mx-12 flex flex-col gap-6">
    <div class="flex flex-col lg:flex-row lg:items-end lg:justify-between gap-4">
      <div class="flex flex-col gap-2">
        {% if section.settings.title != blank %}
          <h2 class="text-2xl font-semibold">{{ section.settings.title }}</h2>
        {% endif %}
        {% if section.settings.rich_text != blank %}
          <div class="prose prose-sm text-gray-600">{{ section.settings.rich_text }}</div>
        {% endif %}
        {% if section.settings.show_swipe_hint %}
          <p class="text-xs text-gray-400 lg:hidden">
            Desliza horizontalmente para ver más productos.
          </p>
        {% endif %}
      </div>
      {% if section.settings.show_view_all %}
        {% assign view_all_url = '' %}
        {% case section.settings.product_source %}
          {% when 'collections' %}
            {% assign view_all_url = section.settings.view_all_link_collections %}
          {% else %}
            {% assign view_all_url = section.settings.view_all_link %}
        {% endcase %}
        {% if view_all_url != blank %}
          <a href="{{ view_all_url }}" class="hidden lg:inline-flex text-gray-600 hover:text-gray-900 underline text-sm">
            {{ section.settings.view_all_text | default: 'Los más vendidos' }}
          </a>
        {% endif %}
      {% endif %}
    </div>

    {% if total_products > 0 %}
      <div class="relative">
        {% if section.settings.show_arrows %}
          <button
            class="hidden lg:flex w-10 h-10 items-center justify-center rounded-full bg-gray-200 text-gray-600 absolute -left-5 top-1/2 -translate-y-1/2 z-10"
            data-carousel-prev
            aria-label="Anterior"
          >
            <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path d="M15 18l-6-6 6-6" stroke-linecap="round" stroke-linejoin="round" />
            </svg>
          </button>
          <button
            class="hidden lg:flex w-10 h-10 items-center justify-center rounded-full bg-gray-900 text-white absolute -right-5 top-1/2 -translate-y-1/2 z-10"
            data-carousel-next
            aria-label="Siguiente"
          >
            <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path d="M9 18l6-6-6-6" stroke-linecap="round" stroke-linejoin="round" />
            </svg>
          </button>
        {% endif %}

        <div
          class="flex gap-4 overflow-x-auto scroll-smooth snap-x snap-mandatory lg:snap-none"
          data-carousel-track
          tabindex="0"
        >
          {{ carousel_products }}
        </div>
      </div>
    {% else %}
      <div class="text-center py-10 text-gray-500">
        {{ section.settings.no_products_message | default: 'No hay productos disponibles en este momento.' }}
      </div>
    {% endif %}
  </div>

  <style>
    #product-carousel-opt-{{ section.id }} [data-carousel-track] {
      scrollbar-width: none;
      -ms-overflow-style: none;
    }

    #product-carousel-opt-{{ section.id }} [data-carousel-track]::-webkit-scrollbar {
      display: none;
    }
  </style>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const section = document.getElementById('product-carousel-opt-{{ section.id }}');
      if (!section) return;

      const track = section.querySelector('[data-carousel-track]');
      const prev = section.querySelector('[data-carousel-prev]');
      const next = section.querySelector('[data-carousel-next]');

      const updateArrows = () => {
        if (!track) return;
        const maxScroll = track.scrollWidth - track.clientWidth - 5;
        if (prev) {
          prev.disabled = track.scrollLeft <= 5;
          prev.classList.toggle('opacity-40', prev.disabled);
        }
        if (next) {
          next.disabled = track.scrollLeft >= maxScroll;
          next.classList.toggle('opacity-40', next.disabled);
        }
      };

      if (track) {
        track.addEventListener('scroll', () => requestAnimationFrame(updateArrows));
      }

      const scrollAmount = () => (track ? track.clientWidth * 0.8 : 0);

      prev?.addEventListener('click', () => {
        track?.scrollBy({ left: -scrollAmount(), behavior: 'smooth' });
      });

      next?.addEventListener('click', () => {
        track?.scrollBy({ left: scrollAmount(), behavior: 'smooth' });
      });

      updateArrows();
    });

    document.addEventListener('click', async (event) => {
      const openBtn = event.target.closest('[data-open-modal]');
      if (openBtn) {
        const modal = document.getElementById(openBtn.dataset.openModal);
        if (modal) {
          const drawer = modal.querySelector('[data-drawer-content]');
          modal.classList.remove('hidden');
          document.body.classList.add('overflow-hidden');
          setTimeout(() => {
            drawer?.classList.remove('translate-y-full');
            drawer?.classList.add('translate-y-0');
          }, 10);
        }
        return;
      }

      const closeBtn = event.target.closest('[data-close-modal]');
      if (closeBtn) {
        const modal = closeBtn.closest('[data-quick-add-modal]');
        const drawer = modal?.querySelector('[data-drawer-content]');
        drawer?.classList.add('translate-y-full');
        drawer?.classList.remove('translate-y-0');
        setTimeout(() => {
          modal?.classList.add('hidden');
          document.body.classList.remove('overflow-hidden');
        }, 300);
        return;
      }

      const modalOverlay = event.target.closest('[data-quick-add-modal]');
      if (modalOverlay && event.target === modalOverlay) {
        const drawer = modalOverlay.querySelector('[data-drawer-content]');
        drawer?.classList.add('translate-y-full');
        drawer?.classList.remove('translate-y-0');
        setTimeout(() => {
          modalOverlay.classList.add('hidden');
          document.body.classList.remove('overflow-hidden');
        }, 300);
        return;
      }

      const addBtn = event.target.closest('[data-add-variant]');
      if (addBtn) {
        const variantId = addBtn.dataset.addVariant;
        if (!variantId) return;
        addBtn.disabled = true;
        addBtn.classList.add('opacity-60');
        try {
          await fetch('/cart/add.js', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id: parseInt(variantId, 10), quantity: 1 }),
          });
          const modal = addBtn.closest('[data-quick-add-modal]');
          const drawer = modal?.querySelector('[data-drawer-content]');
          drawer?.classList.add('translate-y-full');
          drawer?.classList.remove('translate-y-0');
          setTimeout(() => {
            modal?.classList.add('hidden');
            document.body.classList.remove('overflow-hidden');
          }, 300);
          document.dispatchEvent(new CustomEvent('cart:updated'));
        } catch (error) {
          console.error('Add to cart failed', error);
        } finally {
          addBtn.disabled = false;
          addBtn.classList.remove('opacity-60');
        }
      }
    });
  </script>
</section>

{% schema %}
{
  "name": "Product Carousel Opt",
  "tag": "section",
  "class": "section",
  "settings": [
    {
      "type": "text",
      "id": "title",
      "label": "Carousel Title",
      "default": "Los más vendidos"
    },
    {
      "type": "richtext",
      "id": "rich_text",
      "label": "Rich Text",
      "info": "Optional rich text content below the title"
    },
    {
      "type": "header",
      "content": "View All Link"
    },
    {
      "type": "checkbox",
      "id": "show_view_all",
      "label": "Show View All Link",
      "default": true
    },
    {
      "type": "text",
      "id": "view_all_text",
      "label": "View All Text",
      "default": "Los más vendidos"
    },
    {
      "type": "url",
      "id": "view_all_link",
      "label": "View All Link",
      "info": "Used for single collection, tags, and manual selection"
    },
    {
      "type": "url",
      "id": "view_all_link_collections",
      "label": "View All Link (Multiple Collections)",
      "info": "Used when multiple collections are selected"
    },
    {
      "type": "checkbox",
      "id": "show_arrows",
      "label": "Show Navigation Arrows",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_swipe_hint",
      "label": "Show swipe hint",
      "default": true
    },
    {
      "type": "header",
      "content": "Product Selection"
    },
    {
      "type": "select",
      "id": "product_source",
      "label": "Product Source",
      "options": [
        { "value": "collection", "label": "Single Collection" },
        { "value": "collections", "label": "Multiple Collections" },
        { "value": "tags", "label": "Product Tags" },
        { "value": "manual", "label": "Manual Selection" }
      ],
      "default": "collection"
    },
    {
      "type": "collection",
      "id": "collection",
      "label": "Collection",
      "info": "Select products from this collection"
    },
    {
      "type": "collection_list",
      "id": "collections",
      "label": "Collections",
      "limit": 10,
      "info": "Select multiple collections to mix products from"
    },
    {
      "type": "text",
      "id": "product_tags",
      "label": "Product Tags",
      "info": "Comma-separated tags (e.g., 'best-seller,new')"
    },
    {
      "type": "product_list",
      "id": "products",
      "label": "Manual Product Selection",
      "limit": 20
    },
    {
      "type": "range",
      "id": "max_products",
      "label": "Maximum Products",
      "min": 4,
      "max": 20,
      "step": 1,
      "default": 12
    },
    {
      "type": "header",
      "content": "Product Card Display"
    },
    {
      "type": "checkbox",
      "id": "show_badges",
      "label": "Show Product Badges",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_rating",
      "label": "Show Product Rating",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_color_swatches",
      "label": "Show Color Swatches",
      "default": false
    },
    {
      "type": "checkbox",
      "id": "show_size_selector",
      "label": "Show Size Selector",
      "default": true
    },
    {
      "type": "header",
      "content": "Messages"
    },
    {
      "type": "text",
      "id": "no_products_message",
      "label": "No Products Available Message",
      "default": "No hay productos disponibles en este momento."
    },
    {
      "type": "header",
      "content": "Carousel Settings"
    },
    {
      "type": "header",
      "content": "Custom CSS"
    }
  ],
  "presets": [
    {
      "name": "Product Carousel Opt",
      "settings": {
        "title": "Los más vendidos",
        "product_source": "collection"
      }
    }
  ]
}
{% endschema %}
