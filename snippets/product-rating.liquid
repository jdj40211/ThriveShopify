{% comment %}
  Product Rating Snippet
  Calculates average rating and review count from product.metafields.custom.ratings

  Usage: {% render 'product-rating', product: product %}

  Returns:
  - average_rating: calculated average rating (decimal)
  - review_count: total number of reviews
  - has_ratings: boolean indicating if ratings exist
{% endcomment %}

{% assign ratings_metafield = product.metafields.custom.ratings %}
{% assign debug = debug | default: false %}

{% assign average_rating = 0 %}
{% assign review_count = 0 %}
{% assign has_ratings = false %}

{% if ratings_metafield and ratings_metafield.value %}
  {% assign total_rating = 0 %}
  {% assign count = 0 %}
  {% assign debug_list = '' %}

  {%- comment -%}
    ratings_metafield.value is a list of Metaobject references like "gid://shopify/Metaobject/..."
    In Liquid, each item exposes its fields, so access via rating_item.rating.value
  {%- endcomment -%}
  {% for rating_item in ratings_metafield.value %}
    {% assign rating_value = 0 %}
    {% if rating_item.rating and rating_item.rating.value %}
      {% assign rating_value = rating_item.rating.value | plus: 0 %}
    {% elsif rating_item.rating %}
      {% assign rating_value = rating_item.rating | plus: 0 %}
    {% elsif rating_item.fields and rating_item.fields.rating and rating_item.fields.rating.value %}
      {% assign rating_value = rating_item.fields.rating.value | plus: 0 %}
    {% endif %}

    {% if rating_value > 0 and rating_value <= 5 %}
      {% assign total_rating = total_rating | plus: rating_value %}
      {% assign count = count | plus: 1 %}
      {% assign debug_list = debug_list | append: rating_value | append: ',' %}
    {% endif %}
  {% endfor %}

  {% if count > 0 %}
    {% assign average_rating = total_rating | divided_by: count %}
    {% assign review_count = count %}
    {% assign has_ratings = true %}
  {% endif %}
{% endif %}

{% comment %} Round to 1 decimal place {% endcomment %}
{% assign average_rating = average_rating | round: 1 %}

{%- assign star_size = size | default: 'sm' -%}
{%- assign star_color = color | default: 'text-[#f3a000]' -%}
{%- assign show_count_flag = show_count_flag | default: false -%}
{%- assign show_review_count_flag = show_review_count | default: false -%}
{%- assign show_rating_value_flag = show_rating_value | default: false -%}
{%- assign show_review_text_flag = show_review_text | default: false -%}
{%- assign single_star_mode_flag = single_star_mode | default: false -%}

{%- comment -%}
  Render the star-rating here so callers don't rely on snippet variables
{%- endcomment -%}
{% if has_ratings %}
  {% render 'star-rating',
    rating: average_rating,
    size: star_size,
    color: star_color,
    show_count: show_count_flag,
    show_review_count: show_review_count_flag,
    show_rating_value: show_rating_value_flag,
    review_count: review_count,
    show_review_text: show_review_text_flag,
    single_star_mode: single_star_mode_flag
  %}
{% else %}
  {% render 'star-rating',
    rating: 0,
    size: star_size,
    color: star_color,
    show_count: show_count_flag,
    show_review_count: show_review_count_flag,
    show_rating_value: show_rating_value_flag,
    review_count: 0,
    show_review_text: show_review_text_flag,
    single_star_mode: single_star_mode_flag
  %}
{% endif %}

{% if debug %}
  <div class="body-xs" style="opacity:.6">
    <div>ratings_found: {{ ratings_metafield.value.count | default: 0 }}</div>
    <div>
      total: {{ total_rating | default: 0 }} | count: {{ review_count | default: 0 }} | avg:
      {{ average_rating | default: 0 }}
    </div>
  </div>
{% endif %}
