{% comment %}
  Generic Reusable Carousel Snippet

  Parameters:
  - carousel_id: Unique ID for the carousel
  - carousel_class: Additional CSS classes
  - content: The content to be rendered inside swiper-wrapper
  - show_arrows: Whether to show navigation arrows (default: true, hidden on mobile)
  - slides_per_view_mobile: Mobile slides per view (default: 1.35)
  - slides_per_view_desktop: Desktop slides per view (default: 4)
  - space_between_mobile: Mobile space between slides (default: 2)
  - space_between_desktop: Desktop space between slides (default: 4)
  - centered_slides: Whether to center slides (default: true for mobile, false for desktop)
  - free_mode: Whether to enable free mode (default: true)
  - total_items: Total number of items (for arrow state management)
  - padding_left_mobile: Left padding for mobile (default: 16px)
  - padding_right_mobile: Right padding for mobile (default: 16px)
  - padding_left_desktop: Left padding for desktop (default: 48px)
  - padding_right_desktop: Right padding for desktop (default: 48px)
{% endcomment %}

{% assign carousel_id = carousel_id | default: 'carousel' %}
{% assign carousel_class = carousel_class | default: '' %}
{% assign show_arrows = show_arrows | default: true %}
{% assign slides_per_view_mobile = slides_per_view_mobile | default: 1.35 %}
{% assign slides_per_view_desktop = slides_per_view_desktop | default: 4 %}
{% assign space_between_mobile = space_between_mobile | default: 2 %}
{% assign space_between_desktop = space_between_desktop | default: 4 %}
{% assign centered_slides = centered_slides | default: false %}
{% assign free_mode = free_mode | default: true %}
{% assign total_items = total_items | default: 0 %}
{% assign padding_left_mobile = padding_left_mobile | default: 16 %}
{% assign padding_right_mobile = padding_right_mobile | default: 16 %}
{% assign padding_left_desktop = padding_left_desktop | default: 48 %}
{% assign padding_right_desktop = padding_right_desktop | default: 48 %}

<div class="relative overflow-hidden">
  <div
    class="swiper-{{ carousel_id }} {{ carousel_class }}"
    data-carousel-id="{{ carousel_id }}"
    data-carousel-type="generic-carousel"
    style="padding-left: {{ padding_left_mobile }}px; padding-right: {{ padding_right_mobile }}px;"
  >
    <div class="swiper-wrapper">
      {{ content }}
    </div>
  </div>
</div>

<style>
  @media (min-width: 1024px) {
    .swiper-{{ carousel_id }} {
      padding-left: {{ padding_left_desktop }}px !important;
      padding-right: {{ padding_right_desktop }}px !important;
    }
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const carouselElement = document.querySelector('.swiper-{{ carousel_id }}');
    if (!carouselElement) return;

    const initializeCarousel = () => {
      if (carouselElement.dataset.carouselInitialized === 'true') return;
      if (carouselElement.swiper) return;
      if (typeof Swiper === 'undefined') return;

      carouselElement.dataset.carouselInitialized = 'true';

      const swiper = new Swiper(carouselElement, {
        slidesPerView: {{ slides_per_view_mobile | json }},
        spaceBetween: {{ space_between_mobile }},
        {% if centered_slides %}
        centeredSlides: true,
        centeredSlidesBounds: true,
        {% endif %}
        {% if free_mode %}
        freeMode: {
          enabled: true,
          sticky: false,
          momentum: true,
          momentumRatio: 0.25,
          momentumVelocityRatio: 0.5,
          momentumBounce: true,
          momentumBounceRatio: 0.3,
        },
        {% endif %}
        grabCursor: false,
        resistance: true,
        resistanceRatio: 0.85,
        watchSlidesProgress: true,
        watchSlidesVisibility: true,
        snapOnRelease: true,
        snapOnDrag: true,
        snapSwipeThreshold: 0.1,
        snapSwipeDuration: 300,
        breakpoints: {
          1024: {
            slidesPerView: {{ slides_per_view_desktop | json }},
            spaceBetween: {{ space_between_desktop }},
            centeredSlides: false,
            {% if show_arrows %}
            navigation: {
              nextEl: '.product-carousel-next, .look-fit-carousel-next, .carousel-next',
              prevEl: '.product-carousel-prev, .look-fit-carousel-prev, .carousel-prev',
            },
            {% endif %}
            {% if free_mode %}
            freeMode: {
              enabled: true,
              sticky: false,
              momentum: true,
              momentumRatio: 0.25,
              momentumVelocityRatio: 0.5,
              momentumBounce: true,
              momentumBounceRatio: 0.3,
            },
            {% endif %}
          }
        },
        {% if show_arrows %}
        on: {
          init: function() {
            updateGenericArrowStates(this, carouselElement, '{{ carousel_id }}');
          },
          afterInit: function() {
            updateGenericArrowStates(this, carouselElement, '{{ carousel_id }}');
          },
          slideChange: function() {
            updateGenericArrowStates(this, carouselElement, '{{ carousel_id }}');
          },
          activeIndexChange: function() {
            updateGenericArrowStates(this, carouselElement, '{{ carousel_id }}');
          },
          reachBeginning: function() {
            updateGenericArrowStates(this, carouselElement, '{{ carousel_id }}');
          },
          reachEnd: function() {
            updateGenericArrowStates(this, carouselElement, '{{ carousel_id }}');
          },
          fromEdge: function() {
            updateGenericArrowStates(this, carouselElement, '{{ carousel_id }}');
          },
          slideChangeTransitionEnd: function() {
            updateGenericArrowStates(this, carouselElement, '{{ carousel_id }}');
          },
          transitionEnd: function() {
            updateGenericArrowStates(this, carouselElement, '{{ carousel_id }}');
          },
        },
        {% endif %}
      });

      // Store the swiper instance on the element to avoid conflicts
      carouselElement.swiper = swiper;

      {% if show_arrows %}
      // Ensure the desktop arrows are synced after layout settles
      setTimeout(() => {
        updateGenericArrowStates(swiper, carouselElement, '{{ carousel_id }}');
      }, 200);
      {% endif %}
    };

    if ('IntersectionObserver' in window) {
      const observer = new IntersectionObserver((entries, obs) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            initializeCarousel();
            obs.unobserve(entry.target);
          }
        });
      }, { rootMargin: '200px 0px' });

      observer.observe(carouselElement);
    } else {
      initializeCarousel();
    }

    {% if show_arrows %}
    // Function to update arrow states for carousel (desktop only)
    function updateGenericArrowStates(swiper, carouselEl, carouselId) {
      if (window.innerWidth < 1024) {
        return;
      }

      let prevArrow = document.querySelector(`.product-carousel-prev[data-carousel-id="${carouselId}"]`) ||
                      document.querySelector(`.look-fit-carousel-prev[data-carousel-id="${carouselId}"]`);
      let nextArrow = document.querySelector(`.product-carousel-next[data-carousel-id="${carouselId}"]`) ||
                      document.querySelector(`.look-fit-carousel-next[data-carousel-id="${carouselId}"]`);

      if ((!prevArrow || !nextArrow) && carouselEl) {
        const sectionContainer = carouselEl.closest('section, div');
        if (sectionContainer) {
          prevArrow = prevArrow || sectionContainer.querySelector('.carousel-prev');
          nextArrow = nextArrow || sectionContainer.querySelector('.carousel-next');
        }
      }

      if (prevArrow) {
        if (swiper.isBeginning) {
          prevArrow.disabled = true;
          prevArrow.classList.remove('bg-primary', 'text-white', 'cursor-pointer');
          prevArrow.classList.add('bg-gray-300', 'text-gray-500', 'cursor-not-allowed');
          prevArrow.style.pointerEvents = 'none';
        } else {
          prevArrow.disabled = false;
          prevArrow.classList.remove('bg-gray-300', 'text-gray-500', 'cursor-not-allowed');
          prevArrow.classList.add('bg-primary', 'text-white', 'cursor-pointer');
          prevArrow.style.pointerEvents = 'auto';
        }
      }

      if (nextArrow) {
        if (swiper.isEnd) {
          nextArrow.disabled = true;
          nextArrow.classList.remove('bg-primary', 'text-white', 'cursor-pointer');
          nextArrow.classList.add('bg-gray-300', 'text-gray-500', 'cursor-not-allowed');
          nextArrow.style.pointerEvents = 'none';
        } else {
          nextArrow.disabled = false;
          nextArrow.classList.remove('bg-gray-300', 'text-gray-500', 'cursor-not-allowed');
          nextArrow.classList.add('bg-primary', 'text-white', 'cursor-pointer');
          nextArrow.style.pointerEvents = 'auto';
        }
      }
    }
    {% endif %}
  });
</script>
