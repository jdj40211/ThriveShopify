{% comment %}
  Generic Reusable Carousel Snippet

  Parameters:
  - carousel_id: Unique ID for the carousel
  - carousel_class: Additional CSS classes
  - content: The content to be rendered inside swiper-wrapper
  - show_arrows: Whether to show navigation arrows (default: true, hidden on mobile)
  - slides_per_view_mobile: Mobile slides per view (default: 1.35)
  - slides_per_view_desktop: Desktop slides per view (default: 4)
  - space_between_mobile: Mobile space between slides (default: 2)
  - space_between_desktop: Desktop space between slides (default: 4)
  - centered_slides: Whether to center slides (default: true for mobile, false for desktop)
  - free_mode: Whether to enable free mode (default: true)
  - total_items: Total number of items (for arrow state management)
  - padding_left_mobile: Left padding for mobile (default: 16px)
  - padding_right_mobile: Right padding for mobile (default: 16px)
  - padding_left_desktop: Left padding for desktop (default: 48px)
  - padding_right_desktop: Right padding for desktop (default: 48px)
{% endcomment %}

{% assign carousel_id = carousel_id | default: 'carousel' %}
{% assign carousel_class = carousel_class | default: '' %}
{% assign show_arrows = show_arrows | default: true %}
{% assign slides_per_view_mobile = slides_per_view_mobile | default: 1.35 %}
{% assign slides_per_view_desktop = slides_per_view_desktop | default: 4 %}
{% assign space_between_mobile = space_between_mobile | default: 2 %}
{% assign space_between_desktop = space_between_desktop | default: 4 %}
{% assign centered_slides = centered_slides | default: false %}
{% assign free_mode = free_mode | default: true %}
{% assign total_items = total_items | default: 0 %}
{% assign padding_left_mobile = padding_left_mobile | default: 16 %}
{% assign padding_right_mobile = padding_right_mobile | default: 16 %}
{% assign padding_left_desktop = padding_left_desktop | default: 48 %}
{% assign padding_right_desktop = padding_right_desktop | default: 48 %}

<div class="relative overflow-hidden">
  <div
    class="swiper-{{ carousel_id }} {{ carousel_class }}"
    data-carousel-id="{{ carousel_id }}"
    data-carousel-type="generic-carousel"
    style="padding-left: {{ padding_left_mobile }}px; padding-right: {{ padding_right_mobile }}px; -webkit-overflow-scrolling: touch; will-change: transform;"
  >
    <div class="swiper-wrapper" style="will-change: transform;">
      {{ content }}
    </div>
  </div>
</div>

<style>
  /* iOS-specific optimizations */
  .swiper-{{ carousel_id }} {
    -webkit-transform: translateZ(0);
    transform: translateZ(0);
    -webkit-backface-visibility: hidden;
    backface-visibility: hidden;
  }

  .swiper-{{ carousel_id }} .swiper-slide {
    will-change: transform;
    -webkit-transform: translateZ(0);
    transform: translateZ(0);
  }

  /* Critical: Disable unnecessary pointer events on mobile to prevent iOS crash */
  @media (max-width: 1023px) {
    .swiper-{{ carousel_id }} .swiper-slide {
      touch-action: pan-x pan-y !important;
      -webkit-touch-callout: none;
    }

    /* Disable pointer move tracking on product cards in carousel */
    .swiper-{{ carousel_id }} .product-card {
      pointer-events: none !important;
    }

    /* Re-enable pointer events only for interactive elements */
    .swiper-{{ carousel_id }} .product-card a,
    .swiper-{{ carousel_id }} .product-card button {
      pointer-events: auto !important;
    }
  }

  @media (min-width: 1024px) {
    .swiper-{{ carousel_id }} {
      padding-left: {{ padding_left_desktop }}px !important;
      padding-right: {{ padding_right_desktop }}px !important;
    }
  }
</style>

<script>
  (function() {
    // Debug logger for iPhone - Shows errors on screen
    const debugLog = (message, type = 'info') => {
      console.log(`[Carousel {{ carousel_id }}] ${message}`);

      // Show critical errors on screen for mobile debugging
      if (type === 'error' && /iPhone|iPad|iPod/.test(navigator.userAgent)) {
        const errorDiv = document.createElement('div');
        errorDiv.style.cssText = 'position:fixed;top:0;left:0;right:0;background:red;color:white;padding:10px;z-index:99999;font-size:12px';
        errorDiv.textContent = `Carousel Error: ${message}`;
        document.body.appendChild(errorDiv);
        setTimeout(() => errorDiv.remove(), 5000);
      }
    };

    const initCarouselSafely = () => {
      try {
        const carouselElement = document.querySelector('.swiper-{{ carousel_id }}');
        if (!carouselElement) {
          debugLog('Carousel element not found', 'error');
          return;
        }

        debugLog('Starting initialization');

        const initializeCarousel = () => {
          try {
            if (carouselElement.dataset.carouselInitialized === 'true') {
              debugLog('Already initialized');
              return;
            }
            if (carouselElement.swiper) {
              debugLog('Swiper instance already exists');
              return;
            }
            if (typeof Swiper === 'undefined') {
              debugLog('Swiper not loaded yet, retrying...');
              setTimeout(initializeCarousel, 100);
              return;
            }

            debugLog('Initializing Swiper');
            carouselElement.dataset.carouselInitialized = 'true';

            const swiperConfig = {
              slidesPerView: {{ slides_per_view_mobile | json }},
              spaceBetween: {{ space_between_mobile }},
              {% if centered_slides %}
              centeredSlides: true,
              centeredSlidesBounds: true,
              {% endif %}
              {% if free_mode %}
              freeMode: {
                enabled: true,
                sticky: false,
                momentum: true,
                momentumRatio: 0.5,
                momentumVelocityRatio: 1,
                momentumBounce: false,
              },
              {% endif %}
              // Critical iOS-friendly settings to prevent crash
              touchEventsTarget: 'container',
              simulateTouch: true,
              touchStartPreventDefault: false,
              touchStartForcePreventDefault: false,
              touchMoveStopPropagation: true,
              touchReleaseOnEdges: true,
              passiveListeners: true,
              resistance: true,
              resistanceRatio: 0.85,
              watchSlidesProgress: true,
              updateOnWindowResize: false,
              observer: false,
              observeParents: false,
              observeSlideChildren: false,
              // Reduce touch ratio for smoother iOS performance
              touchRatio: 1,
              touchAngle: 45,
              longSwipesRatio: 0.5,
              longSwipesMs: 300,
              followFinger: true,
              threshold: 5,
              // Prevent iOS memory issues
              preventInteractionOnTransition: false,
              runCallbacksOnInit: false,
              breakpoints: {
                1024: {
                  slidesPerView: {{ slides_per_view_desktop | json }},
                  spaceBetween: {{ space_between_desktop }},
                  centeredSlides: false,
                  {% if show_arrows %}
                  navigation: {
                    nextEl: '.product-carousel-next, .look-fit-carousel-next, .carousel-next',
                    prevEl: '.product-carousel-prev, .look-fit-carousel-prev, .carousel-prev',
                  },
                  {% endif %}
                  {% if free_mode %}
                  freeMode: {
                    enabled: true,
                    sticky: false,
                    momentum: true,
                    momentumRatio: 0.5,
                    momentumVelocityRatio: 1,
                    momentumBounce: false,
                  },
                  {% endif %}
                }
              },
              {% if show_arrows %}
              on: {
                init: function() {
                  try {
                    updateGenericArrowStates(this, carouselElement, '{{ carousel_id }}');
                  } catch(e) {
                    debugLog('Error in init: ' + e.message, 'error');
                  }
                },
                slideChange: function() {
                  try {
                    if (window.innerWidth >= 1024) {
                      updateGenericArrowStates(this, carouselElement, '{{ carousel_id }}');
                    }
                  } catch(e) {
                    debugLog('Error in slideChange: ' + e.message, 'error');
                  }
                },
                reachBeginning: function() {
                  try {
                    if (window.innerWidth >= 1024) {
                      updateGenericArrowStates(this, carouselElement, '{{ carousel_id }}');
                    }
                  } catch(e) {
                    debugLog('Error in reachBeginning: ' + e.message, 'error');
                  }
                },
                reachEnd: function() {
                  try {
                    if (window.innerWidth >= 1024) {
                      updateGenericArrowStates(this, carouselElement, '{{ carousel_id }}');
                    }
                  } catch(e) {
                    debugLog('Error in reachEnd: ' + e.message, 'error');
                  }
                },
              },
              {% endif %}
            };

            debugLog('Creating Swiper instance');
            const swiper = new Swiper(carouselElement, swiperConfig);

            // Store the swiper instance on the element to avoid conflicts
            carouselElement.swiper = swiper;
            debugLog('Swiper instance created successfully');

            {% if show_arrows %}
            // Ensure the desktop arrows are synced after layout settles
            setTimeout(() => {
              try {
                updateGenericArrowStates(swiper, carouselElement, '{{ carousel_id }}');
              } catch(e) {
                debugLog('Error updating arrows: ' + e.message, 'error');
              }
            }, 200);
            {% endif %}
          } catch(e) {
            debugLog('Error initializing carousel: ' + e.message, 'error');
            carouselElement.dataset.carouselInitialized = 'false';
          }
        };

        if ('IntersectionObserver' in window) {
          const observer = new IntersectionObserver((entries, obs) => {
            entries.forEach(entry => {
              if (entry.isIntersecting) {
                debugLog('Carousel visible, initializing');
                initializeCarousel();
                obs.unobserve(entry.target);
              }
            });
          }, { rootMargin: '200px 0px' });

          observer.observe(carouselElement);
        } else {
          debugLog('No IntersectionObserver, initializing immediately');
          initializeCarousel();
        }

        {% if show_arrows %}
        // Function to update arrow states for carousel (desktop only)
        function updateGenericArrowStates(swiper, carouselEl, carouselId) {
          if (window.innerWidth < 1024) {
            return;
          }

          let prevArrow = document.querySelector(`.product-carousel-prev[data-carousel-id="${carouselId}"]`) ||
                          document.querySelector(`.look-fit-carousel-prev[data-carousel-id="${carouselId}"]`);
          let nextArrow = document.querySelector(`.product-carousel-next[data-carousel-id="${carouselId}"]`) ||
                          document.querySelector(`.look-fit-carousel-next[data-carousel-id="${carouselId}"]`);

          if ((!prevArrow || !nextArrow) && carouselEl) {
            const sectionContainer = carouselEl.closest('section, div');
            if (sectionContainer) {
              prevArrow = prevArrow || sectionContainer.querySelector('.carousel-prev');
              nextArrow = nextArrow || sectionContainer.querySelector('.carousel-next');
            }
          }

          if (prevArrow) {
            if (swiper.isBeginning) {
              prevArrow.disabled = true;
              prevArrow.classList.remove('bg-primary', 'text-white', 'cursor-pointer');
              prevArrow.classList.add('bg-gray-300', 'text-gray-500', 'cursor-not-allowed');
              prevArrow.style.pointerEvents = 'none';
            } else {
              prevArrow.disabled = false;
              prevArrow.classList.remove('bg-gray-300', 'text-gray-500', 'cursor-not-allowed');
              prevArrow.classList.add('bg-primary', 'text-white', 'cursor-pointer');
              prevArrow.style.pointerEvents = 'auto';
            }
          }

          if (nextArrow) {
            if (swiper.isEnd) {
              nextArrow.disabled = true;
              nextArrow.classList.remove('bg-primary', 'text-white', 'cursor-pointer');
              nextArrow.classList.add('bg-gray-300', 'text-gray-500', 'cursor-not-allowed');
              nextArrow.style.pointerEvents = 'none';
            } else {
              nextArrow.disabled = false;
              nextArrow.classList.remove('bg-gray-300', 'text-gray-500', 'cursor-not-allowed');
              nextArrow.classList.add('bg-primary', 'text-white', 'cursor-pointer');
              nextArrow.style.pointerEvents = 'auto';
            }
          }
        }
        {% endif %}
      } catch(e) {
        debugLog('Critical error: ' + e.message, 'error');
      }
    };

    // Wait for both DOM and Swiper library
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initCarouselSafely);
    } else {
      initCarouselSafely();
    }
  })();
</script>
